uartimcs{"name":"c8f2c9b6-ae16-4013-b373-b4d1a7d05865","id":"/providers/Microsoft.Flow/flows/c8f2c9b6-ae16-4013-b373-b4d1a7d05865","type":"Microsoft.Flow/flows","properties":{"apiId":"/providers/Microsoft.PowerApps/apis/shared_logicflows","displayName":"Calibration Notice (Testing)","definition":{"metadata":{"workflowEntityId":null,"processAdvisorMetadata":null,"flowChargedByPaygo":null,"flowclientsuspensionreason":"None","flowclientsuspensiontime":null,"flowclientsuspensionreasondetails":null,"creator":{"id":"a005f8fc-901c-41d0-92a4-877fa915a01c","type":"User","tenantId":"e96fa72b-c8d6-4957-96bd-c7f8dc30cc88"},"provisioningMethod":"FromDefinition","failureAlertSubscription":true,"clientLastModifiedTime":"2023-04-13T02:15:25.9051747Z"},"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","contentVersion":"1.0.0.0","parameters":{"$connections":{"defaultValue":{},"type":"Object"},"$authentication":{"defaultValue":{},"type":"SecureObject"}},"triggers":{"Trigger_Time":{"recurrence":{"frequency":"Month","interval":1,"timeZone":"China Standard Time","startTime":"2022-12-08T09:00:00.000Z"},"metadata":{"operationMetadataId":"fba28644-f41d-4e19-a1a2-b83d14df8bda"},"type":"Recurrence","description":"Trigger at 17:00 every 8th day of month"}},"actions":{"External_Calibration_Due_Date_Rows":{"runAfter":{"Internal_Due_Date_Criteria":["Succeeded"]},"metadata":{"operationMetadataId":"302bd17b-99d5-4ba1-b1df-a28ee54573eb"},"type":"InitializeVariable","inputs":{"variables":[{"name":"externalRowArray","type":"array"}]},"description":"Create an array variable to hold valid external row results. Empty initially."},"Total_External_Row_Number":{"runAfter":{"Processing_Data":["Succeeded"]},"metadata":{"operationMetadataId":"8fef9d8d-3c49-42c4-9afb-d6578b87c883"},"type":"Compose","inputs":"@length(variables('externalRowArray'))","description":"Get the number of external calibration."},"Total_Internal_Row_Number":{"runAfter":{"Total_External_Row_Number":["Succeeded"]},"metadata":{"operationMetadataId":"794e293f-400d-4d1f-9673-d348a79ec88d"},"type":"Compose","inputs":"@length(variables('internalRowArray'))","description":"Get the number of internal calibration."},"Internal_Calibration_Due_Date_Rows":{"runAfter":{"External_Calibration_Due_Date_Rows":["Succeeded"]},"metadata":{"operationMetadataId":"45817243-7b45-48a3-9fee-a85a2a37d98e"},"type":"InitializeVariable","inputs":{"variables":[{"name":"internalRowArray","type":"array"}]},"description":"Create an array variable to hold valid row results. Empty initially."},"Send_Email_Decision":{"actions":{"Styling_internal_HTML_table":{"runAfter":{"CSS_Email_Template":["Succeeded"]},"metadata":{"operationMetadataId":"f999e15a-79bb-436c-8ba3-33b203d8f436"},"type":"Compose","inputs":"@{outputs('CSS_Template')}@{body('Create_internal_HTML_table')}","description":"Style the HTML table for better appearance."},"Styling_external_HTML_table":{"runAfter":{"Styling_internal_HTML_table":["Succeeded"]},"metadata":{"operationMetadataId":"b0a8405f-d275-4566-bfea-e2bec5d17a76"},"type":"Compose","inputs":"@{outputs('CSS_Template')}@{body('Create_external_HTML_table')}","description":"Style the HTML table for better appearance."},"Send_Email_to_Stakeholders":{"runAfter":{"Create_PDF":["Succeeded"]},"metadata":{"operationMetadataId":"2c331db8-8e27-4985-998e-f2180ab2fdf9"},"type":"OpenApiConnection","inputs":{"host":{"apiId":"/providers/Microsoft.PowerApps/apis/shared_office365","connectionName":"shared_office365","operationId":"SendEmailV2"},"parameters":{"emailMessage/To":"uartimcs@example.com","emailMessage/Subject":"Monthly HG Equipment Calibration Alert @{outputs('Today_Date')}","emailMessage/Body":"<p><span style=\"font-size: 18px\"><strong>Monthly HG Equipment Calibration Alert (Issue Date:&nbsp;</strong></span><span style=\"font-size: 18px\"><strong>@{outputs('Today_Date')}</strong></span><span style=\"font-size: 18px\"><strong>)</strong></span><span style=\"font-size: 18px\"><strong>@{outputs('Styling_Panel')}</strong></span><span style=\"font-size: 18px\"><strong></strong></span><br>\n<span style=\"font-size: 16px\"><u><strong>External Calibration</strong></u></span><br>\n<span style=\"font-size: 14px\">Please note that the following equipment through external calibration is overdue/due within </span><span style=\"font-size: 14px\">@{outputs('External_Due_Date_Criteria')}</span><span style=\"font-size: 14px\"> days.<br>\nTotal number of outstanding calibration: </span><span style=\"font-size: 14px\">@{outputs('Total_External_Row_Number')}</span><span style=\"font-size: 14px\"></span><span style=\"font-size: 14px\">@{outputs('Styling_external_HTML_table')}</span><span style=\"font-size: 14px\"></span></p>\n<p><span style=\"font-size: 16px\"><u><strong>Internal Calibration</strong></u></span><br>\n<span style=\"font-size: 14px\">Please note that the following equipment through internal calibration is overdue/due within </span><span style=\"font-size: 14px\">@{outputs('Internal_Due_Date_Criteria')}</span><span style=\"font-size: 14px\"> days.<br>\nTotal number of outstanding calibration: </span><span style=\"font-size: 14px\">@{outputs('Total_Internal_Row_Number')}</span><span style=\"font-size: 14px\"></span><span style=\"font-size: 14px\">@{outputs('Styling_internal_HTML_table')}</span><span style=\"font-size: 14px\"></span></p>","emailMessage/Attachments":[{"Name":"@outputs('Convert_to_PDF_File')?['headers/x-ms-file-name']","ContentBytes":"@body('Convert_to_PDF_File')"}],"emailMessage/Importance":"Normal"},"authentication":"@parameters('$authentication')"}},"Create_external_HTML_table":{"runAfter":{},"metadata":{"operationMetadataId":"13766d2f-f648-456e-bbfd-45eefab43887"},"type":"Table","inputs":{"from":"@variables('externalRowArray')","format":"HTML"},"description":"Create an HTML table using the external result array."},"Create_PDF":{"actions":{"PDF_HTML_table":{"runAfter":{},"metadata":{"operationMetadataId":"b71826a7-a2c1-4377-9fe1-23c73f263863"},"type":"Compose","inputs":"<style>\nh3 {\n  padding-bottom: 5px;\n  margin: 2px;\n}\n</style>\n<h3><b>Monthly HG Equipment Calibration Alert (Issue Date: @{outputs('Today_Date')})</b></h3><br/>\n\n<h3><b><u>External Calibration</u></b></h3>\nPlease note that the following equipment through external calibration is overdue/due within @{outputs('External_Due_Date_Criteria')} days:<br/>Total number of outstanding calibration: @{outputs('Total_External_Row_Number')}@{outputs('Styling_external_HTML_table')}<br/>\n\n<h3><b><u>Internal Calibration</u></b></h3>\nPlease note that the following equipment through internal calibration is overdue/due within @{outputs('Internal_Due_Date_Criteria')} days:<br/>Total number of outstanding calibration: @{outputs('Total_Internal_Row_Number')}@{outputs('Styling_internal_HTML_table')}"},"Create_HTML_File":{"runAfter":{"PDF_HTML_table":["Succeeded"]},"metadata":{"operationMetadataId":"4b2e9d3b-f5c0-4ea0-b843-2d558474765c"},"type":"OpenApiConnection","inputs":{"host":{"apiId":"/providers/Microsoft.PowerApps/apis/shared_onedriveforbusiness","connectionName":"shared_onedriveforbusiness","operationId":"CreateFile"},"parameters":{"folderPath":"/Documents","name":"HG_Calibration_@{outputs('Today_Date')}.html","body":"@outputs('PDF_HTML_table')"},"authentication":"@parameters('$authentication')"},"runtimeConfiguration":{"contentTransfer":{"transferMode":"Chunked"}}},"Convert_to_PDF_File":{"runAfter":{"Create_HTML_File":["Succeeded"]},"metadata":{"operationMetadataId":"553d616a-f757-4a65-9098-1877dd7d95b1"},"type":"OpenApiConnection","inputs":{"host":{"apiId":"/providers/Microsoft.PowerApps/apis/shared_onedriveforbusiness","connectionName":"shared_onedriveforbusiness","operationId":"ConvertFileByPath"},"parameters":{"path":"@outputs('Create_HTML_File')?['body/Path']","type":"PDF"},"authentication":"@parameters('$authentication')"}},"Create_PDF_File_in_Directory_for_Email_Attachment":{"runAfter":{"Convert_to_PDF_File":["Succeeded"]},"metadata":{"operationMetadataId":"aecac293-7f44-4dcc-9570-27a927fa2aea"},"type":"OpenApiConnection","inputs":{"host":{"apiId":"/providers/Microsoft.PowerApps/apis/shared_onedriveforbusiness","connectionName":"shared_onedriveforbusiness","operationId":"CreateFile"},"parameters":{"folderPath":"/Documents","name":"@outputs('Convert_to_PDF_File')?['headers/x-ms-file-name']","body":"@body('Convert_to_PDF_File')"},"authentication":"@parameters('$authentication')"},"runtimeConfiguration":{"contentTransfer":{"transferMode":"Chunked"}}}},"runAfter":{"Styling_Panel":["Succeeded"]},"metadata":{"operationMetadataId":"1e69bea4-087a-4942-9d6f-44f8080178a9"},"type":"Scope"},"Styling_Panel":{"runAfter":{"Styling_external_HTML_table":["Succeeded"]},"metadata":{"operationMetadataId":"54c39723-a4d9-4783-a9e4-2396d3d4f0a9"},"type":"Compose","inputs":"@{outputs('CSS_Template')}@{outputs('Create_Panel')}"},"CSS_Template":{"runAfter":{"Create_Panel":["Succeeded"]},"metadata":{"operationMetadataId":"141d198b-6c85-4595-ba31-1de1c4778ba4"},"type":"Compose","inputs":"<style>\nspan { \n  font-family: Arial;\n  font-size: 18px;\n  padding-bottom: 5px;\n}\ntable {\n  font-family: Arial;\n  background-color: #EFEFEF;\n  border-collapse: collapse;\n  width: 95%;\n}\ntable td, table th {\n  border: 0px;\n}\n\ntable td {\n  font-size: 13px;\n  padding: 8px;\n}\ntable th {\n  font-size: 14px;\n  font-weight: bold;\n  text-align: left;\n  padding: 8px;\n  background-color: #008080;\n  color: white;\n}\n</style>"},"Create_internal_HTML_table":{"runAfter":{"Create_external_HTML_table":["Succeeded"]},"metadata":{"operationMetadataId":"f383940d-a734-43d2-886a-0f1f88d99fce"},"type":"Table","inputs":{"from":"@variables('internalRowArray')","format":"HTML"},"description":"Create an HTML table using the internal result array."},"Create_Panel":{"runAfter":{"Create_internal_HTML_table":["Succeeded"]},"metadata":{"operationMetadataId":"65b7c7b6-6d4a-466e-994d-297ea84e5e7f"},"type":"Compose","inputs":"<table>\n<tr>\n<th colspan=\"2\">SharePoint Site Shortcuts</th>\n</tr>\n<tr>\n<td>\n<a href=\"https://example.sharepoint.com/sites/hk-cp-example/SitePages/HL-Quality-Assurance-Page.aspx?env=WebView\">HL QA Page</a>\n</td>\n<td><a href=\"https://example.sharepoint.com/sites/hk-cp-example/Lists/example%20Equipment%20List?env=WebViewList\">Equipment List (HG)</a>\n</td>\n</tr>\n</table>"},"CSS_Email_Template":{"runAfter":{"CSS_Template":["Succeeded"]},"metadata":{"operationMetadataId":"2eb7b1c2-b5e0-4bfe-bdd2-0104ca45a5cd"},"type":"Compose","inputs":"<style>\n* {\n font-famil: Arial;\n font-size: 14px;\n}\n\nspan {\n  font-size: 18px;\n}\n</style>"}},"runAfter":{"Total_Internal_Row_Number":["Succeeded"]},"expression":{"greater":["@add(outputs('Total_External_Row_Number'),outputs('Total_Internal_Row_Number'))",0]},"metadata":{"operationMetadataId":"698d0e2e-bfca-407c-8877-b2f721abeba5"},"type":"If","description":"If sum of rows > 0, send Email to notify the stakeholders."},"Today_Date":{"runAfter":{},"metadata":{"operationMetadataId":"2b74371c-bafd-40fb-a915-8efbdab2076a"},"type":"Compose","inputs":"@addDays(utcNow(),0,'yyyy-MM-dd')","description":"Today in yyyy-MM-dd"},"Processing_Data":{"actions":{"Get_items":{"runAfter":{},"metadata":{"operationMetadataId":"1a387210-d5e6-49be-9554-24c31334e058"},"type":"OpenApiConnection","inputs":{"host":{"apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline","connectionName":"shared_sharepointonline","operationId":"GetItems"},"parameters":{"dataset":"https://example.sharepoint.com/sites/hk-cp-example","table":"9e6eefc1-71ae-4d6c-a46e-b07e4cc869cb","$filter":"Equipment_x0020_Status eq 'Normal' or Equipment_x0020_Status eq 'Calibrating'","$orderby":"Title"},"authentication":"@parameters('$authentication')"},"description":"Get items from particular SharePoint list, filter items and order by the equipment id.  Pagination set to 2000 rows.","runtimeConfiguration":{"paginationPolicy":{"minimumItemCount":2000}}},"Apply_to_each":{"foreach":"@outputs('Get_items')?['body/value']","actions":{"Get_item":{"runAfter":{},"metadata":{"operationMetadataId":"e051f593-66a7-469e-9ada-b1498a30c191"},"type":"OpenApiConnection","inputs":{"host":{"apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline","connectionName":"shared_sharepointonline","operationId":"GetItem"},"parameters":{"dataset":"https://example.sharepoint.com/sites/hk-cp-example","table":"9e6eefc1-71ae-4d6c-a46e-b07e4cc869cb","id":"@items('Apply_to_each')?['ID']"},"authentication":"@parameters('$authentication')"},"description":"To each valid row, check condition and add to the result array when conditions are satisfied."},"Check_Conditions":{"actions":{"Condition":{"actions":{"Append_to_array_variable":{"runAfter":{"Convert_Next_Calibration_Date_Time_zone":["Succeeded"]},"metadata":{"operationMetadataId":"a85bbc42-f135-4637-a4b9-a4d9c880e6f0"},"type":"AppendToArrayVariable","inputs":{"name":"externalRowArray","value":{"Equipment No":"@outputs('Get_item')?['body/Title']","Equipment Name":"@outputs('Get_item')?['body/Name_x0020_of_x0020_Equipment']","Type of Calibration":"@outputs('Get_item')?['body/CalibrationType/Value']","Cal. Frequency":"@outputs('Get_item')?['body/Calibration_x0020_Frequency_x002']","Calibration Due Date":"@body('Convert_Next_Calibration_Date_Time_zone')","Equipment Status":"@outputs('Get_item')?['body/Equipment_x0020_Status/Value']","HOKLAS":"@outputs('Get_item')?['body/HOKLASItems/Value']"}},"description":"Add necessary data to the array for show."},"Convert_Next_Calibration_Date_Time_zone":{"runAfter":{},"metadata":{"operationMetadataId":"4455562c-e2f0-461a-8ec8-7e4b8d00e747"},"type":"Expression","kind":"ConvertTimeZone","inputs":{"baseTime":"@outputs('Get_item')?['body/Due_x0020_Date_x0020_of_x0020_Ca']","formatString":"yyyy-MM-dd","sourceTimeZone":"GMT Standard Time","destinationTimeZone":"China Standard Time"},"description":"System time zone GMT + 8 to get the correct date"}},"runAfter":{},"else":{"actions":{"Condition_2":{"actions":{"Append_valid_information_to_the_array":{"runAfter":{"Change_the_time_zone_to_correct_one":["Succeeded"]},"metadata":{"operationMetadataId":"b6a03455-b553-45f7-9589-345c7679e824"},"type":"AppendToArrayVariable","inputs":{"name":"internalRowArray","value":{"Equipment No":"@outputs('Get_item')?['body/Title']","Equipment Name":"@outputs('Get_item')?['body/Name_x0020_of_x0020_Equipment']","Type of Calibration":"@outputs('Get_item')?['body/CalibrationType/Value']","Cal. Frequency":"@outputs('Get_item')?['body/Calibration_x0020_Frequency_x002']","Calibration Due Date":"@body('Change_the_time_zone_to_correct_one')","Equipment Status":"@outputs('Get_item')?['body/Equipment_x0020_Status/Value']","HOKLAS":"@outputs('Get_item')?['body/HOKLASItems/Value']"}},"description":"Add necessary data to the array for show."},"Change_the_time_zone_to_correct_one":{"runAfter":{},"metadata":{"operationMetadataId":"67d35fb1-1cee-442a-ba80-c4d04bd685e1"},"type":"Expression","kind":"ConvertTimeZone","inputs":{"baseTime":"@outputs('Get_item')?['body/Due_x0020_Date_x0020_of_x0020_Ca']","formatString":"yyyy-MM-dd","sourceTimeZone":"GMT Standard Time","destinationTimeZone":"China Standard Time"}}},"runAfter":{},"expression":{"and":[{"equals":["@outputs('Get_item')?['body/CalibrationType/Value']","Internal"]},{"lessOrEquals":["@outputs('Get_item')?['body/Due_x0020_Date_x0020_of_x0020_Ca']","@addDays(utcNow(),outputs('Internal_Due_Date_Criteria'),'yyyy-MM-dd')"]}]},"metadata":{"operationMetadataId":"84705af0-660b-47c3-9e60-de922b754514"},"type":"If","description":"Further reduce the range to 30 days due date + Internal Calibration"}}},"expression":{"equals":["@outputs('Get_item')?['body/CalibrationType/Value']","External"]},"metadata":{"operationMetadataId":"5d7979c4-4981-41b3-b485-325dc4abde97"},"type":"If"}},"runAfter":{"Get_item":["Succeeded"]},"expression":{"and":[{"not":{"equals":["@outputs('Get_item')?['body/Due_x0020_Date_x0020_of_x0020_Ca']",""]}},{"lessOrEquals":["@outputs('Get_item')?['body/Due_x0020_Date_x0020_of_x0020_Ca']","@addDays(utcNow(),outputs('External_Due_Date_Criteria'),'yyyy-MM-dd')"]}]},"metadata":{"operationMetadataId":"ab8a1ac9-1843-4b95-bb68-c99d46c4a938"},"type":"If","description":"Check condition for each row to remove unwanted rows. Reduce the range to equipment due within 60 days."}},"runAfter":{"Get_items":["Succeeded"]},"metadata":{"operationMetadataId":"7ba032c2-f292-4dcf-9dc1-38ccbff37927"},"type":"Foreach"}},"runAfter":{"Internal_Calibration_Due_Date_Rows":["Succeeded"]},"metadata":{"operationMetadataId":"1e5ee24d-84dd-4ef1-a461-b3e67347067c"},"type":"Scope","description":"Blackbox to hide processing data details and error handling."},"External_Due_Date_Criteria":{"runAfter":{"Today_Date":["Succeeded"]},"metadata":{"operationMetadataId":"606b8557-fd2c-4d0c-bf1e-e43777a154cd"},"type":"Compose","inputs":60,"description":"External Due Date Criteria: Today + 60 days"},"Internal_Due_Date_Criteria":{"runAfter":{"External_Due_Date_Criteria":["Succeeded"]},"metadata":{"operationMetadataId":"9d24efa6-ded4-4b4f-89e9-1212af39b4d5"},"type":"Compose","inputs":30,"description":"External Due Date Criteria: Today + 30 days"}}},"connectionReferences":{"shared_office365":{"connectionName":"shared-office365-18fb1200-8fc5-4927-a127-15837e09ec7f","source":"Embedded","id":"/providers/Microsoft.PowerApps/apis/shared_office365","tier":"NotSpecified"},"shared_onedriveforbusiness":{"connectionName":"shared-onedriveforbu-5c5e7422-2223-483a-a785-75c3f57874eb","source":"Embedded","id":"/providers/Microsoft.PowerApps/apis/shared_onedriveforbusiness","tier":"NotSpecified"},"shared_sharepointonline":{"connectionName":"shared-sharepointonl-7f606626-abd0-483d-bd8e-3ec7a9e38bbf","source":"Embedded","id":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline","tier":"NotSpecified"}},"flowFailureAlertSubscribed":false,"isManaged":false}}